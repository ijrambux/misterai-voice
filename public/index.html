<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Mister AI Chat</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body>
<canvas id="stars"></canvas>

<div class="chat-container">

    <h1 class="title">ðŸ¤– Ø¯Ø±Ø¯Ø´Ø© Mister AI ðŸ’¬</h1>

    <div id="messages" class="messages"></div>

    <div class="input-area">
        <button id="voiceBtn">ðŸŽ¤ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ø«</button>
        <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
        <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<script>
const socket = io();
const username = localStorage.getItem("nickname") || "Ù…Ø¬Ù‡ÙˆÙ„";

// Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ
function sendMessage() {
    let input = document.getElementById("msg");
    if (input.value.trim() === "") return;
    socket.emit("chatMessage", { user: username, text: input.value });
    input.value = "";
}

// Ø§Ø³ØªÙ„Ø§Ù… Ù†Øµ
socket.on("chatMessage", data => {
    let box = document.getElementById("messages");
    let div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<strong>${data.user}:</strong> ${data.text}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
});

// Ø§Ù„ØµÙˆØª
let chunks = [];
let mediaRecorder;

navigator.mediaDevices.getUserMedia({ audio: true })
.then(stream => mediaRecorder = new MediaRecorder(stream));

document.getElementById("voiceBtn").onmousedown = () => {
    mediaRecorder.start();
    voiceBtn.innerHTML = "ðŸŽ™ï¸ ØªØ³Ø¬ÙŠÙ„...";
};

document.getElementById("voiceBtn").onmouseup = () => {
    mediaRecorder.stop();
    voiceBtn.innerHTML = "ðŸŽ¤ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ø«";

    mediaRecorder.onstop = () => {
        let blob = new Blob(chunks, { type: "audio/webm" });
        chunks = [];
        let reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
            socket.emit("voiceMessage", {
                user: username,
                audio: reader.result
            });
        };
    };

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
};

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØµÙˆØª
socket.on("voiceMessage", data => {
    let box = document.getElementById("messages");
    let wrap = document.createElement("div");
    wrap.className = "msg";
    wrap.innerHTML = `<strong>${data.user} ðŸŽ¤:</strong><br>`;

    let audio = document.createElement("audio");
    audio.controls = true;
    audio.src = data.audio;

    wrap.appendChild(audio);
    box.appendChild(wrap);
    box.scrollTop = box.scrollHeight;
});
</script>

<script src="stars.js"></script>
</body>
</html>

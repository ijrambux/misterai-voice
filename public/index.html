<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Mister AI Chat ğŸ¤–</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>

<canvas id="stars"></canvas>

<div class="chat-container">

    <h1 class="title">ğŸ¤– Ø¯Ø±Ø¯Ø´Ø© Mister AI ğŸ’¬</h1>

    <div id="users" class="users-list"></div>

    <div id="messages" class="messages"></div>

    <div class="input-section">
        <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." />
        <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <div class="emoji-bar">
        <button onclick="addEmoji('ğŸš€')">ğŸš€</button>
        <button onclick="addEmoji('â¤ï¸')">â¤ï¸</button>
        <button onclick="addEmoji('ğŸ¤–')">ğŸ¤–</button>
        <button onclick="addEmoji('ğŸ”¥')">ğŸ”¥</button>
        <button onclick="addEmoji('ğŸ˜„')">ğŸ˜„</button>
    </div>

    <button class="voice-btn" id="voiceBtn">ğŸ¤ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ø«</button>

</div>

<script>
// Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
const socket = io();

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
function sendMessage() {
    let input = document.getElementById("msg");
    if (input.value.trim() === "") return;

    socket.emit("chatMessage", input.value);
    input.value = "";
}

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
socket.on("chatMessage", (msg) => {
    let box = document.getElementById("messages");
    let div = document.createElement("div");
    div.className = "message";
    div.innerHTML = msg;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
});

// Ø¥Ø¶Ø§ÙØ© Ø¥Ù…ÙˆØ¬ÙŠ
function addEmoji(e) {
    document.getElementById("msg").value += e;
}

// ====== Ø§Ù„ØµÙˆØª Push-To-Talk ======
let voiceBtn = document.getElementById("voiceBtn");
let mediaRecorder;
let chunks = [];

voiceBtn.onmousedown = async () => {
    voiceBtn.innerHTML = "ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦";
    let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();

    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
};

voiceBtn.onmouseup = () => {
    voiceBtn.innerHTML = "ğŸ¤ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ø«";
    mediaRecorder.stop();

    mediaRecorder.onstop = () => {
        let blob = new Blob(chunks, { type: "audio/webm" });
        chunks = [];
        let reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
            socket.emit("voiceMessage", reader.result);
        };
    };
};

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØµÙˆØª
socket.on("voiceMessage", (audio) => {
    let audioElem = document.createElement("audio");
    audioElem.controls = true;
    audioElem.src = audio;

    let box = document.getElementById("messages");
    let wrap = document.createElement("div");
    wrap.className = "message";
    wrap.appendChild(audioElem);

    box.appendChild(wrap);
    box.scrollTop = box.scrollHeight;
});

// ===== Ø®Ù„ÙÙŠØ© Ù†Ø¬ÙˆÙ… ØªØªØ³Ø§Ù‚Ø· =====
const canvas = document.getElementById("stars");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

let stars = [];
for (let i = 0; i < 200; i++) {
    stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        s: Math.random() * 2,
        sp: Math.random() * 2 + 0.5
    });
}

function animateStars() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    stars.forEach(st => {
        st.y += st.sp;
        if (st.y > canvas.height) {
            st.y = -5;
            st.x = Math.random() * canvas.width;
        }
        ctx.fillStyle = "#00ffc8";
        ctx.beginPath();
        ctx.arc(st.x, st.y, st.s, 0, 2 * Math.PI);
        ctx.fill();
    });
    requestAnimationFrame(animateStars);
}
animateStars();
</script>

</body>
</html>
